var isBubbleExist=!1,d3=window.d3,$=window.$,G=window.G,moment=window.moment,bubbleChart=function(){function t(t){_.css({"background-image":"-webkit-linear-gradient(left ,#222 0%,#222 "+t+"%,#d3d3d5 "+t+"%, #d3d3d5 100%)"})}function e(t){_.css({"background-image":"-webkit-linear-gradient(left ,#222 0%,#222 "+t+"%,#d3d3d5 "+t+"%, #d3d3d5 100%)"});var e=moment.duration({days:b/100*t});f=moment("2016-11-09").add(e),p!==y(f._d)&&(d3.json("../../src/faked2.json",function(t,e){t&&console.log(t),n(e,"c")}),p=y(f._d))}function n(t,e){e=e||"c";var n={},o=a(t),c=[],s=0;for(var f in DB.serviceItems)n[DB.serviceItems[f]]="";for(var p in t){var m={};for(var v in DB.areas)m[DB.areas[v]]=0;for(var v in t[p].listData)m[t[p].listData[v].area]++;var b=Object.keys(m).sort(function(t,e){return m[e]-m[t]});n[t[p].item]=b[0]+m[b[0]]+"件<br>"+b[1]+m[b[1]]+"件<br>"+b[2]+m[b[2]]+"件<br>"}for(var p in o.children)o.children[p].value>=s&&(s=o.children[p].value),c.push(o.children[p].value);var y=d3.quantile(c,.1),_=u.nodes(o).filter(function(t){return t.parent});if("s"===e)var h=d.selectAll("circle").data(_).enter().append("circle").attr({cx:function(t){return t.x},cy:function(t){return 0},r:function(t){return t.r},fill:function(t,e){return t.itemColor},id:function(t,e){return"id"+t.item},opacity:0});else var h=d.selectAll("circle").data(_);h.on("mouseover",function(t){d3.select(this).attr({stroke:"rgba(0, 0, 0, 0.2)","stroke-width":3}),l.transition().duration(100).style({opacity:.9}),l.html('<span class="bubble_tooltipName">'+d3.select(this).attr("id").slice(2)+"( "+t.value+"件 )</span><br>"+n[d3.select(this).attr("id").slice(2)]).style({left:d3.event.pageX+"px",top:d3.event.pageY+"px"})}).on("mouseout",function(){l.transition().duration(100).style({opacity:0}),d3.select(this).attr({"stroke-width":1})}),"s"===e?h.transition().duration(1e3).attr({opacity:1,cy:function(t){return t.y}}):h.transition().duration(1e3).attr({cx:function(t){return t.x},cy:function(t){return t.y},r:function(t){return t.r}}),i();d.selectAll("#item_text").data(_).enter().append("text").attr({x:function(t){return t.x-5},y:function(t){return t.y-5},id:"item_text"}).style({"text-anchor":"middle"}).text(function(t){if(t.value>y&&d3.select("#id"+t.item).attr("r")/t.item.length>=7)return t.item}).transition().duration(1e3).attr({x:function(t){return t.x},y:function(t){return t.y},opacity:1});r(t)}function a(t){var e=[];return t.forEach(function(t,n){var a=t.caseCount,r=G.colorServiceItem[n];e.push({value:a,itemColor:r,item:t.item})}),{children:e}}function r(t){var e=t.sort(function(t,e){return t.caseCount<e.caseCount?1:t.caseCount>e.caseCount?-1:0});$(".descriptionTime").text(y(f._d));for(var n=0;n<3;n++)$(".descriptionItem>#item"+n).text(n+1+". "+e[n].item+": "+e[n].caseCount+"件")}function i(){d.selectAll("#item_text").remove()}if(!isBubbleExist){isBubbleExist=!0;var o=800,c=600,s=7,l=d3.select("#bubbule_tooltip").append("div").attr("class","bubble_tooltip").attr("opacity",1);d3.json("../src/faked.json",function(t,e){t&&console.log(t),n(e,"s")});var u=d3.layout.pack().sort(null).size([o,c]).padding(s),d=d3.select("#bubble_chart").append("svg").attr({width:o,height:c,id:"bubble_chart"}),f=moment("2016-11-09"),p="2016-11-09",m=new moment,v=0,b=parseInt((m._d-f._d)/864e5,10),y=d3.time.format("%Y-%m-%d"),_=$("input");_.on("mouseenter",function(){_.on("click",function(){v=_.val(),e(v)}),_.on("mousemove",function(){v=_.val(),t(v)})});var h,x="pause";d3.select("#play_icon").on("click",function(){"pause"===x?(x="play",$("#play_icon").removeClass("fa-play").addClass("fa-pause"),$("html, body").animate({scrollTop:$("#scroll_container").offset().top-5},"easeInBack"),h=setInterval(function(){if(y(f._d)!==y(m._d)&&v<100){var t=moment.duration({days:1});f=f.add(t),v=parseInt(v,10)+100/b,e(parseInt(v,10));var n=document.getElementById("slider_input");n.value=parseInt(v,10),(y(f._d)===y(m._d)||v>=100)&&clearInterval(h)}else clearIntnterval(h)},2e3)):"play"===x&&(x="pause",clearInterval(h),$("#play_icon").removeClass("fa-pause").addClass("fa-play"))}),d3.select("#stop_icon").on("click",function(){var t=document.getElementById("slider_input");v=0,e(v),t.value=parseInt(v,10),clearInterval(h),x="pause",$("#play_icon").removeClass("fa-pause").addClass("fa-play")})}};