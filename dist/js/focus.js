!function(){function t(t,a,r){var n=0;for(var e in t.listData)t.listData[e][a]==r&&(n+=1);return n}function a(t,a){console.log(a),t.selectAll("path.pointer").data(a).enter().append("path").attr("class","pointer").style("fill","none").style("stroke","black").style("stroke-width",.5).attr("marker-end","url(#circ)").attr("d",function(t){return t.cx>t.ox?"M"+t.sx+","+t.sy+"L"+t.ox+","+t.oy+" "+t.cx+","+t.cy:"M"+t.ox+","+t.oy+"L"+t.sx+","+t.sy+" "+t.cx+","+t.cy})}var r,n={top:50,right:30,bottom:40,left:400},e=960-n.left-n.right,i=1500-n.top-n.bottom,s=600,o=1e3,c=d3.select("#bar-chart").append("svg").attr("width",e+n.left+n.right).attr("height",i+n.top+n.bottom).append("g").attr("transform","translate("+n.left+","+n.top+")"),l=d3.select("#pie-chart").append("svg").attr("width",o).attr("height",s).append("g").attr("transform","translate("+o/2+","+s/2+")"),u=Math.min(o,s)/2,d=["#E57373 ","#D4E157 ","#CDDC39 ","#AB47BC ","#8E24AA ","#BA68C8 ","#9FA8DA ","#7986CB ","#5C6BC0 ","#3F51B5 ","#3949AB ","#303F9F ","#283593 ","#1A237E ","#B2DFDB ","#4DB6AC ","#009688 ","#00796B ","#004D40 ","#A5D6A7 ","#81C784 ","#66BB6A ","#66BB6A ","#43A047 ","#388E3C ","#2E7D32 ","#FFCCBC ","#FF8A65 ","#FF5722 ","#E64A19 ","#BF360C ","#8D6E63 ","#6D4C41 "],p={"違規停車":0,"路燈故障":1,"噪音舉發":2,"騎樓舉發":3,"道路維修":4,"交通運輸":5,"髒亂及污染":6,"民生管線":7,"動物救援":8};d3.json("../../src/fack_areas.json",function(a,n){a&&console.log(a);var e=n[0];r=e.area;var i=[],s=0,o=0;for(var c in p){var d=[];d.push(p[c]),d.push(t(e,"serviceName",c)),d.push(c),i.push(d)}i=i.sort(function(t,a){return d3.descending(t[1],a[1])});for(var c in i)s>2&&(o+=i[c][1]),s+=1;var d=[];d.push(9),d.push(o),d.push("其他"),i.splice(3,s-3,d);var f=d3.layout.pie(),g=d3.svg.arc().innerRadius(u/3).outerRadius(u/4),h=d3.svg.arc().innerRadius(u/2).outerRadius(u/3),x=l.selectAll("g.arc").data(f(i.map(function(t,a,r){return t[1]}))).enter().append("g").attr({class:"arc"}),m=["#E57373","#DCE775","#F06292","#BA68C8","#7986CB","#4DB6AC","#81C784","#FF8A65","#A1887F","#E0E0E0"],y=x.append("path").attr({fill:function(t,a){return m[i[a][0]]},d:g,class:"pie-path",id:function(t,a){return i[a][2]}});y.transition().duration(1e3).attr({d:h})}),d3.json("../../src/fack_items.json",function(t,n){function s(t){return t>0}function o(){return d3.svg.axis().scale(h).orient("bottom").ticks(4)}var p=[];for(var f in n)n[f].caseCount>0&&p.push(n[f]);var g=p.map(function(t){return t.item}),h=d3.scale.linear().domain(d3.extent(p,function(t){return t.caseCount})).nice().range([0,e]),x=d3.scale.ordinal().domain(g).rangeRoundBands([0,i],.1),m=d3.svg.axis().scale(h).orient("top").tickSize(0).ticks(10).tickPadding(10).tickFormat(d3.format("d")),y=d3.svg.axis().scale(x).orient("left").tickSize(0).tickPadding(10);c.append("g").attr("class","grid").attr("transform","translate(0,"+i+")").call(o().tickSize(-i,0,0).tickFormat(""));var v=c.selectAll(".bar").data(p).enter().append("g").attr("class","bar"),C=v.append("rect").attr("class","bar").attr("x",function(t){return h(Math.min(0,t.caseCount))+4}).attr("y",function(t){return x(t.item)+10}).attr("width",0).attr("height",20).attr("rx",5).attr("ry",5).attr("fill",function(t,a){return d[a]}).style("fill-opacity",.5);C.transition().delay(500).duration(function(t,a){return 60*a}).ease("linear").attr("width",function(t){return h(t.caseCount)-h(0)}).style("fill-opacity",1),p.sort(function(t,a){return d3.descending(t.caseCount,a.caseCount)}),console.log("data:"),console.log(p);var A=d3.layout.pie().sort(null),g=(d3.layout.pie().sort(null),p.map(function(t){return t.caseCount})),g=g.filter(s),B=A(g);console.log("first pie2"),console.log(A(g));var k=d3.svg.arc().innerRadius(u/3).outerRadius(u/4),F=d3.svg.arc().innerRadius(u-100).outerRadius(u-50),D=l.selectAll("g.arcs").data(B).enter().append("g").attr({class:"arcs"}),E=p.map(function(t){return t.item}),b=D.append("path").attr({fill:function(t,a){return d[a]},d:k,class:"pie-path",id:function(t,a){return E[a]+"_inner"}});b.transition().duration(1e3).attr({d:F}),B.forEach(function(t){var a=t.a=t.startAngle+(t.endAngle-t.startAngle)/2-Math.PI/2;t.cy=Math.sin(a)*(u-75),t.cx=Math.cos(a)*(u-75)});var R=[];console.log(B),l.selectAll("text").data(B).enter().append("text").attr("text-anchor","middle").attr("x",function(t,a){return t.x=Math.cos(t.a)*(u-20)}).attr("y",function(t,a){return t.y=Math.sin(t.a)*(u-20)}).text(function(t,a){return E[a]}).each(function(t,r){var n=this.getBBox();t.sx=t.x-n.width/2-2,t.ox=t.x+n.width/2+2,t.sy=t.oy=t.y+5,R.push(t),r===B.length-1&&a(l,R)}),l.append("defs").append("marker").attr("id","circ").attr("markerWidth",6).attr("markerHeight",6).attr("refX",3).attr("refY",3).append("circle").attr("cx",3).attr("cy",3).attr("r",3),x=d3.scale.ordinal().domain(p.map(function(t){return t.item})).rangeRoundBands([0,i],.1),C.data(p).transition().delay(function(t,a){return 50*a}).duration(1e3).attr("width",function(t){return h(t.caseCount)-h(0)}).attr("y",function(t,a){return x(t.item)+10}).style("fill-opacity",1),y=d3.svg.axis().scale(x).orient("left").tickSize(0).tickPadding(10),v.append("text").text(function(t){return t.caseCount+"件"}).attr("x",function(t,a){return h(t.caseCount)+10}).attr("y",function(t){return x(t.item)+23}).attr("class","bartip"),c.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(m),c.append("g").attr("class","y axis").attr("transform","translate("+h(0)+",0)").call(y),l.append("text").attr({class:"area_name",x:0,y:0,"text-anchor":"middle"}).text(r),console.log(r)})}();