!function(t){function e(e,a,n,i){function o(t,e,a){var r=0;for(var n in t.listData)t.listData[n][e]===a&&(r+=t.listData[n].caseCount);return r}function s(){x.append("text").attr("x",function(){var t=B.caseCount;return t<10?-25:t<100?-60:t<1e3?-90:void 0}).attr("y",0).attr("id","focus_caseCount_"+e).attr("class","focus_caseCount").text(B.caseCount),x.append("text").attr("x",function(){var t=parseInt($("#focus_caseCount_"+e).attr("x")),a=B.caseCount;return a<10?t+55:a<100?t+100:a<1e3?t+160:void 0}).attr("y",-4).attr("class","focus_caseCountI").text("件"),x.append("text").attr({class:"time_intaveral",x:0,y:40,"text-anchor":"middle"}).text(g+" ~ "+y)}function c(){return d3.svg.axis().scale(W).orient("bottom").ticks(0)}function l(t,e){t.selectAll("path.pointer").data(e).enter().append("path").attr("class",function(t){var e;return e=t.value>_/40?"pointer":"foo"}).style("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-opacity",.2).attr("marker-end","url(#circ)").attr("d",function(t){return t.cx>t.ox?"M"+t.sx+","+t.sy+"L"+t.ox+","+t.oy+" "+t.cx+","+t.cy:"M"+t.ox+","+t.oy+"L"+t.sx+","+t.sy+" "+t.cx+","+t.cy})}function u(t){for(var e in DB.areasE)if(DB.areasE[e].toLowerCase()===t.toLowerCase())return e}function d(t){return t>0}var f={top:50,right:300,bottom:40,left:350},p=$("#pie-chart").width(),v=600,m=Math.min(p,v)/2,h=[],g="",y="",x=d3.select("#pie-chart").append("svg").attr("width",p).attr("height",v).append("g").attr("transform","translate("+p/2+","+v/2+")"),C=d3.select("#pie-chart").append("tooltip").attr("class","toolTip"),k=u(e);console.log(e),$(".infocus").off("click"),$(".infocus .reactive").click(function(){var t=$(this).attr("value");t.length<2?($(".active").removeClass("active"),$(this).addClass("active"),G.focusArea(e,t,g,y)):G.select("item_overview")}),$("#self-define").off("click"),$("#self-define").click(function(){$(".ui.modal").modal({onApprove:function(){g=$("#startDate").val(),y=$("#endDate").val(),""!==g&&""!==y&&G.focusArea(e,"s",g,y)}}).modal("show");var t=$(this).attr("value");t.length<2?($(".active").removeClass("active"),$(this).addClass("active")):G.select("item_overview")}),$(".area_name").text(k);var A={"違規停車":0,"路燈故障":1,"噪音舉發":2,"騎樓舉發":3,"道路維修":4,"交通運輸":5,"髒亂及汙染":6,"民生管線":7,"動物救援":8,"其他":9};if("s"!==a?(g=t.getTimeString(t.dateAdd(t.now,a,-1)),y=t.getTimeString(t.now)):(g=n,y=i),"台南市"===k){console.log("yoyoyo");var w=G.getItemsData(g,y,DB.areas),D=[],b=[{area:"台南市",caseCount:0,listData:D}];w.areasArray.forEach(function(t,e){b[0].caseCount+=t.caseCount,Array.prototype.push.apply(D,t.listData)}),w.areasArray=b}else var w=G.getItemsData(g,y,[k]),b=w.areasArray;var M=w.itemsArray,_=w.count;console.log(w,b);var B=b[0];for(var R in A){var I=[];I.push(A[R]),I.push(o(B,"serviceName",R)),I.push(R),h.push(I)}var S=d3.layout.pie().sort(null);S=S(h.map(function(t,e,a){return t[1]}));var E=d3.svg.arc().innerRadius(m-195).outerRadius(m-145),F=d3.svg.arc().innerRadius(m-165).outerRadius(m-115),T=x.selectAll("g.arc").data(S).enter().append("g").attr({class:"arc"}),Y=T.append("path").attr({fill:function(t,e){return G.colorServiceName[h[e][0]]},d:E,class:"pie-path",id:function(t,e){return h[e][2]}}).on("mousemove",function(t,e){C.style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-25+"px").style("display","inline-block").html(h[e][2]+"<br>"+h[e][1]+"件")}).on("mouseout",function(t){C.style("display","none")});Y.transition().duration(400).ease("sin").attr({d:F}),setTimeout(s,0);var z=[];M.forEach(function(t,e){t.caseCount>0&&z.push(t)});var L=1e3-f.left-f.right,P=46*M.length-f.top-f.bottom,X=d3.select("#bar-chart").append("svg").attr("width",L+f.left+f.right).attr("height",P+f.top+f.bottom).append("g").attr("transform","translate("+f.left+","+f.top+")"),N=z.map(function(t){return t.item}),H=M.map(function(t){return t.item}),W=d3.scale.linear().domain(d3.extent(M,function(t){return t.caseCount})).nice().range([0,L]),j=d3.scale.ordinal().domain(H).rangeRoundBands([0,P],.1),q=d3.svg.axis().scale(W).orient("top").tickSize(0).ticks(10).tickPadding(10).tickFormat(d3.format("d")),J=d3.svg.axis().scale(j).orient("left").tickSize(0).tickPadding(10);X.append("g").attr("class","grid").attr("transform","translate(0,"+P+")").call(c().tickSize(-P,0,0).tickFormat(""));var K=X.selectAll(".bar").data(M).enter().append("g").attr("class","bar"),O=K.append("rect").attr("class","bar").attr("x",function(t){return W(Math.min(0,t.caseCount))+4}).attr("y",function(t){return j(t.item)+10}).attr("width",0).attr("height",20).attr("rx",5).attr("ry",5).attr("fill",function(t,e){for(var a in DB.areas)if(DB.serviceItems[a]===t.item)return G.colorServiceItem[a]}).style("fill-opacity",.2),Q=d3.layout.pie().sort(null);N=z.map(function(t){return t.caseCount}),N=N.filter(d);var U=Q(N),V=[],Z=d3.svg.arc().innerRadius(m-130).outerRadius(m-95),tt=d3.svg.arc().innerRadius(m-100).outerRadius(m-65),T=x.selectAll("g.arcs").data(U).enter().append("g").attr({class:"arcs"}),et=z.map(function(t){return t.item}),Y=T.append("path").attr({fill:function(t,e){for(var a in DB.areas)if(DB.serviceItems[a]===et[e])return G.colorServiceItem[a]},d:Z,class:"pie-path",id:function(t,e){return et[e]+"_inner"}}).on("mousemove",function(t,e){C.style("left",d3.event.pageX+10+"px").style("top",d3.event.pageY-25+"px").style("display","inline-block").html(et[e]+"<br>"+t.value+"件")}).on("mouseout",function(t){C.style("display","none")});Y.transition().duration(400).ease("sin").attr({d:tt}),U.forEach(function(t){var e=t.a=t.startAngle+(t.endAngle-t.startAngle)/2-Math.PI/2;t.cy=Math.sin(e)*(m-75),t.cx=Math.cos(e)*(m-75)}),x.selectAll("text").data(U).enter().append("text").attr("text-anchor","middle").attr("class","focus_markerText").attr("x",function(t){return t.x=Math.cos(t.a)*(m-20)*1.5,t.x}).attr("y",function(t){return t.y=Math.sin(t.a)*(m-20)*1.02,t.y}).text(function(t,e){return t.value<_/40?"":et[e]+" "+r(t.value/_*100,1)+"%"}).each(function(t,e){var a=this.getBBox();t.sx=t.x-a.width/2-2,t.ox=t.x+a.width/2+2,t.sy=t.oy=t.y+5,V.push(t),e===U.length-1&&l(x,V)}),x.selectAll(".foo").remove(),x.append("defs").append("marker").attr("id","circ").attr("markerWidth",10).attr("markerHeight",10).attr("refX",5).attr("refY",5).append("circle").attr("cx",5).attr("cy",5).style("fill-opacity",.6).attr("r",5),M.sort(function(t,e){return d3.descending(t.caseCount,e.caseCount)}),j=d3.scale.ordinal().domain(M.map(function(t){return t.item})).rangeRoundBands([0,P],.1),O.attr("y",function(t,e){return j(t.item)+10}).style("fill-opacity",1),O.transition().delay(function(t,e){return 30*e}).duration(800).ease("bounce").attr("width",function(t){return W(t.caseCount)-W(0)}),J=d3.svg.axis().scale(j).orient("left").tickSize(0).tickPadding(10),K.append("text").text(function(t){return t.caseCount+"件"}).attr("x",function(t){return W(t.caseCount)+10}).attr("y",function(t){return j(t.item)+23}).attr("class","bartip"),X.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(q),X.append("g").attr("class","y axis").attr("transform","translate("+W(0)+",0)").call(J)}function a(){d3.select("#pie-chart").selectAll("*").remove(),d3.select("#bar-chart").selectAll("*").remove()}function r(t,e){var a=Math.pow(10,e);return Math.round(t*a)/a}function n(){$("#rangestart").calendar({type:"date",inline:!0,endCalendar:$("#rangeend"),formatter:{date:function(t,e){if(!t)return"";var a=t.getDate(),r=t.getMonth()+1,n=t.getFullYear(),i=n+"-"+r+"-"+a;return i}}}),$("#rangeend").calendar({type:"date",inline:!0,startCalendar:$("#rangestart"),formatter:{date:function(t,e){if(!t)return"";var a=t.getDate(),r=t.getMonth()+1,n=t.getFullYear(),i=n+"-"+r+"-"+a;return i}}})}t.focus=e,t.resetFocus=a,n(),$(".ui.dropdown.focus_selectArea").dropdown({onChange:function(t,e){var a=$(".active").attr("value"),r=$("#startDate").val(),n=$("#endDate").val();G.focusArea(t,a,r,n)}})}(window);