function filtJSON(t,a,r){var e=0;for(var n in t.listData)t.listData[n][a]==r&&(e+=1);return e}function drawPath(t,a){console.log(a),t.selectAll("path.pointer").data(a).enter().append("path").attr("class","pointer").style("fill","none").style("stroke","black").style("stroke-width",.5).attr("marker-end","url(#circ)").attr("d",function(t){return t.cx>t.ox?"M"+t.sx+","+t.sy+"L"+t.ox+","+t.oy+" "+t.cx+","+t.cy:"M"+t.ox+","+t.oy+"L"+t.sx+","+t.sy+" "+t.cx+","+t.cy})}var margin={top:50,right:30,bottom:40,left:400},bar_width=960-margin.left-margin.right,bar_height=1500-margin.top-margin.bottom,pie_height=600,pie_width=1e3,areaName,svg=d3.select("#bar-chart").append("svg").attr("width",bar_width+margin.left+margin.right).attr("height",bar_height+margin.top+margin.bottom).append("g").attr("transform","translate("+margin.left+","+margin.top+")"),pie_svg=d3.select("#pie-chart").append("svg").attr("width",pie_width).attr("height",pie_height).append("g").attr("transform","translate("+pie_width/2+","+pie_height/2+")"),radius=Math.min(pie_width,pie_height)/2,color=["#E57373 ","#D4E157 ","#CDDC39 ","#AB47BC ","#8E24AA ","#BA68C8 ","#9FA8DA ","#7986CB ","#5C6BC0 ","#3F51B5 ","#3949AB ","#303F9F ","#283593 ","#1A237E ","#B2DFDB ","#4DB6AC ","#009688 ","#00796B ","#004D40 ","#A5D6A7 ","#81C784 ","#66BB6A ","#66BB6A ","#43A047 ","#388E3C ","#2E7D32 ","#FFCCBC ","#FF8A65 ","#FF5722 ","#E64A19 ","#BF360C ","#8D6E63 ","#6D4C41 "],service_name={"違規停車":0,"路燈故障":1,"噪音舉發":2,"騎樓舉發":3,"道路維修":4,"交通運輸":5,"髒亂及污染":6,"民生管線":7,"動物救援":8},array=[],count=0,sum=0;d3.json("../../src/fack_areas.json",function(t,a){t&&console.log(t);var r=a[0];areaName=r.area;var e=[],n=0,i=0;for(var s in service_name){var o=[];o.push(service_name[s]),o.push(filtJSON(r,"serviceName",s)),o.push(s),e.push(o)}e=e.sort(function(t,a){return d3.descending(t[1],a[1])});for(var s in e)n>2&&(i+=e[s][1]),n+=1;var o=[];o.push(9),o.push(i),o.push("其他"),e.splice(3,n-3,o);var c=d3.layout.pie(),d=d3.svg.arc().innerRadius(radius/3).outerRadius(radius/4),u=d3.svg.arc().innerRadius(radius/2).outerRadius(radius/3),l=pie_svg.selectAll("g.arc").data(c(e.map(function(t,a,r){return t[1]}))).enter().append("g").attr({class:"arc"}),p=["#E57373","#DCE775","#F06292","#BA68C8","#7986CB","#4DB6AC","#81C784","#FF8A65","#A1887F","#E0E0E0"],g=l.append("path").attr({fill:function(t,a){return p[e[a][0]]},d:d,class:"pie-path",id:function(t,a){return e[a][2]}});g.transition().duration(1e3).attr({d:u})}),d3.json("../../src/fack_items.json",function(t,a){function r(t){return t>0}function e(){return d3.svg.axis().scale(o).orient("bottom").ticks(4)}var n=[];for(var i in a)a[i].caseCount>0&&n.push(a[i]);var s=n.map(function(t){return t.item}),o=d3.scale.linear().domain(d3.extent(n,function(t){return t.caseCount})).nice().range([0,bar_width]),c=d3.scale.ordinal().domain(s).rangeRoundBands([0,bar_height],.1),d=d3.svg.axis().scale(o).orient("top").tickSize(0).ticks(10).tickPadding(10).tickFormat(d3.format("d")),u=d3.svg.axis().scale(c).orient("left").tickSize(0).tickPadding(10);svg.append("g").attr("class","grid").attr("transform","translate(0,"+bar_height+")").call(e().tickSize(-bar_height,0,0).tickFormat(""));var l=svg.selectAll(".bar").data(n).enter().append("g").attr("class","bar"),p=l.append("rect").attr("class","bar").attr("x",function(t){return o(Math.min(0,t.caseCount))+4}).attr("y",function(t){return c(t.item)+10}).attr("width",0).attr("height",20).attr("rx",5).attr("ry",5).attr("fill",function(t,a){return color[a]}).style("fill-opacity",.5);p.transition().delay(500).duration(function(t,a){return 60*a}).ease("linear").attr("width",function(t){return o(t.caseCount)-o(0)}).style("fill-opacity",1),n.sort(function(t,a){return d3.descending(t.caseCount,a.caseCount)}),console.log("data:"),console.log(n);var g=d3.layout.pie().sort(null),s=(d3.layout.pie().sort(null),n.map(function(t){return t.caseCount})),s=s.filter(r),h=g(s);console.log("first pie2"),console.log(g(s));var f=d3.svg.arc().innerRadius(radius/3).outerRadius(radius/4),m=d3.svg.arc().innerRadius(radius-100).outerRadius(radius-50),v=pie_svg.selectAll("g.arcs").data(h).enter().append("g").attr({class:"arcs"}),x=n.map(function(t){return t.item}),y=v.append("path").attr({fill:function(t,a){return color[a]},d:f,class:"pie-path",id:function(t,a){return x[a]+"_inner"}});y.transition().duration(1e3).attr({d:m}),h.forEach(function(t){var a=t.a=t.startAngle+(t.endAngle-t.startAngle)/2-Math.PI/2;t.cy=Math.sin(a)*(radius-75),t.cx=Math.cos(a)*(radius-75)});var _=[];console.log(h),pie_svg.selectAll("text").data(h).enter().append("text").attr("text-anchor","middle").attr("x",function(t,a){return t.x=Math.cos(t.a)*(radius-20)}).attr("y",function(t,a){return t.y=Math.sin(t.a)*(radius-20)}).text(function(t,a){return x[a]}).each(function(t,a){var r=this.getBBox();t.sx=t.x-r.width/2-2,t.ox=t.x+r.width/2+2,t.sy=t.oy=t.y+5,_.push(t),a===h.length-1&&drawPath(pie_svg,_)}),pie_svg.append("defs").append("marker").attr("id","circ").attr("markerWidth",6).attr("markerHeight",6).attr("refX",3).attr("refY",3).append("circle").attr("cx",3).attr("cy",3).attr("r",3),c=d3.scale.ordinal().domain(n.map(function(t){return t.item})).rangeRoundBands([0,bar_height],.1),p.data(n).transition().delay(function(t,a){return 50*a}).duration(1e3).attr("width",function(t){return o(t.caseCount)-o(0)}).attr("y",function(t,a){return c(t.item)+10}).style("fill-opacity",1),u=d3.svg.axis().scale(c).orient("left").tickSize(0).tickPadding(10),l.append("text").text(function(t){return t.caseCount+"件"}).attr("x",function(t,a){return o(t.caseCount)+10}).attr("y",function(t){return c(t.item)+23}).attr("class","bartip"),svg.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(d),svg.append("g").attr("class","y axis").attr("transform","translate("+o(0)+",0)").call(u),pie_svg.append("text").attr({class:"area_name",x:0,y:0,"text-anchor":"middle"}).text(areaName),console.log(areaName)});