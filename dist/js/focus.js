function focus(t,e,a){function r(t,e,a){var r=0;for(var n in t.listData)t.listData[n][e]===a&&(r+=1);return r}function n(t,e){t.selectAll("path.pointer").data(e).enter().append("path").attr("class",function(t){var e;return e=t.value>y/40?"pointer":"foo"}).style("fill","none").style("stroke","black").style("stroke-width",1).style("stroke-opacity",.2).attr("marker-end","url(#circ)").attr("d",function(t){return t.cx>t.ox?"M"+t.sx+","+t.sy+"L"+t.ox+","+t.oy+" "+t.cx+","+t.cy:"M"+t.ox+","+t.oy+"L"+t.sx+","+t.sy+" "+t.cx+","+t.cy})}$(".infocus").show(),$(".infocus").off("click");var i=e;$(".infocus .reactive").off("click").click(function(){$(this).addClass("active").siblings(".item").removeClass("active");var e=$(this).attr("value");G.select("item_focus"),d3.select("#pie-chart").selectAll("*").remove(),d3.select("#bar-chart").selectAll("*").remove(),focus(t,i,e),$("#item_overview").addClass("active")});for(var s in DB.areasE)if(DB.areasE[s]===t){t=s;break}console.log("state:focus-"+t);var o,c={top:50,right:300,bottom:40,left:350},l=600,u=1e3,d=Math.min(u,l)/2,p=[],f=d3.select("#pie-chart").append("svg").attr("width",u).attr("height",l).append("g").attr("transform","translate("+u/2+","+l/2+")"),m=d3.select("#pie-chart").append("tooltip").attr("class","toolTip"),v={"違規停車":0,"路燈故障":1,"噪音舉發":2,"騎樓舉發":3,"道路維修":4,"交通運輸":5,"髒亂及汙染":6,"民生管線":7,"動物救援":8},h=getTimeString(DateAdd(now,a,-1)),g=getTimeString(now);d3.json("../../src/fack_areas.json",function(e,a){e&&console.log(e);var n=a[0];o=t;for(var i in v){var s=[];s.push(v[i]),s.push(r(n,"serviceName",i)),s.push(i),p.push(s)}var c=d3.layout.pie().sort(null);c=c(p.map(function(t,e,a){return t[1]}));var l=d3.svg.arc().innerRadius(d-195).outerRadius(d-145),u=d3.svg.arc().innerRadius(d-165).outerRadius(d-115),h=f.selectAll("g.arc").data(c).enter().append("g").attr({class:"arc"}),g=h.append("path").attr({fill:function(t,e){return G.colorServiceName[p[e][0]]},d:l,class:"pie-path",id:function(t,e){return p[e][2]}}).on("mousemove",function(t,e){m.style("left",d3.event.pageX+10+"px"),m.style("top",d3.event.pageY-25+"px"),m.style("display","inline-block"),m.html(p[e][2]+"<br>"+p[e][1]+"件")}).on("mouseout",function(t){m.style("display","none")});g.transition().duration(400).ease("sin").attr({d:u})});var y=0;d3.json("../../src/fack_items.json",function(e,a){function r(){return d3.svg.axis().scale(k).orient("bottom").ticks(0)}function i(t){return t>0}var s=[];for(var o in a)a[o].caseCount>0&&(s.push(a[o]),y+=a[o].caseCount);var l=1e3-c.left-c.right,u=46*a.length-c.top-c.bottom,p=d3.select("#bar-chart").append("svg").attr("width",l+c.left+c.right).attr("height",u+c.top+c.bottom).append("g").attr("transform","translate("+c.left+","+c.top+")"),v=s.map(function(t){return t.item}),x=a.map(function(t){return t.item}),k=d3.scale.linear().domain(d3.extent(a,function(t){return t.caseCount})).nice().range([0,l]),b=d3.scale.ordinal().domain(x).rangeRoundBands([0,u],.1),A=d3.svg.axis().scale(k).orient("top").tickSize(0).ticks(10).tickPadding(10).tickFormat(d3.format("d")),C=d3.svg.axis().scale(b).orient("left").tickSize(0).tickPadding(10);p.append("g").attr("class","grid").attr("transform","translate(0,"+u+")").call(r().tickSize(-u,0,0).tickFormat(""));var w=p.selectAll(".bar").data(a).enter().append("g").attr("class","bar"),B=w.append("rect").attr("class","bar").attr("x",function(t){return k(Math.min(0,t.caseCount))+4}).attr("y",function(t){return b(t.item)+10}).attr("width",0).attr("height",20).attr("rx",5).attr("ry",5).attr("fill",function(t,e){for(var a in DB.areas)if(DB.serviceItems[a]===t.item)return G.colorServiceItem[a]}).style("fill-opacity",.2),R=d3.layout.pie().sort(null),v=(d3.layout.pie().sort(null),s.map(function(t){return t.caseCount})),v=v.filter(i),D=R(v),M=d3.svg.arc().innerRadius(d-130).outerRadius(d-95),S=d3.svg.arc().innerRadius(d-100).outerRadius(d-65),$=f.selectAll("g.arcs").data(D).enter().append("g").attr({class:"arcs"}),_=s.map(function(t){return t.item}),I=$.append("path").attr({fill:function(t,e){for(var a in DB.areas)if(DB.serviceItems[a]===_[e])return G.colorServiceItem[a]},d:M,class:"pie-path",id:function(t,e){return _[e]+"_inner"}}).on("mousemove",function(t,e){m.style("left",d3.event.pageX+10+"px"),m.style("top",d3.event.pageY-25+"px"),m.style("display","inline-block"),m.html(_[e]+"<br>"+t.value+"件")}).on("mouseout",function(t){m.style("display","none")});I.transition().duration(400).ease("sin").attr({d:S}),D.forEach(function(t){var e=t.a=t.startAngle+(t.endAngle-t.startAngle)/2-Math.PI/2;t.cy=Math.sin(e)*(d-75),t.cx=Math.cos(e)*(d-75)});var j=[];f.selectAll("text").data(D).enter().append("text").attr("text-anchor","middle").attr("x",function(t,e){return t.x=Math.cos(t.a)*(d-20)*1.25}).attr("y",function(t,e){return t.y=Math.sin(t.a)*(d-20)}).text(function(t,e){return t.value<y/40?"":_[e]}).each(function(t,e){var a=this.getBBox();t.sx=t.x-a.width/2-2,t.ox=t.x+a.width/2+2,t.sy=t.oy=t.y+5,j.push(t),e===D.length-1&&n(f,j)}),f.selectAll(".foo").remove(),f.append("defs").append("marker").attr("id","circ").attr("markerWidth",10).attr("markerHeight",10).attr("refX",5).attr("refY",5).append("circle").attr("cx",5).attr("cy",5).style("fill-opacity",.6).attr("r",5),a.sort(function(t,e){return d3.descending(t.caseCount,e.caseCount)}),b=d3.scale.ordinal().domain(a.map(function(t){return t.item})).rangeRoundBands([0,u],.1),B.attr("y",function(t,e){return b(t.item)+10}).style("fill-opacity",1),B.transition().delay(function(t,e){return 30*e}).duration(800).ease("bounce").attr("width",function(t){return k(t.caseCount)-k(0)}),C=d3.svg.axis().scale(b).orient("left").tickSize(0).tickPadding(10),w.append("text").text(function(t){return t.caseCount+"件"}).attr("x",function(t,e){return k(t.caseCount)+10}).attr("y",function(t){return b(t.item)+23}).attr("class","bartip"),p.append("g").attr("class","x axis").attr("transform","translate(0,0)").call(A),p.append("g").attr("class","y axis").attr("transform","translate("+k(0)+",0)").call(C),f.append("text").attr({class:"area_name",x:0,y:0,"text-anchor":"middle"}).text(t),f.append("text").attr({class:"time_intaveral",x:0,y:40,"text-anchor":"middle"}).text(h+" ~ "+g)})}function resetFocus(){d3.select("#pie-chart").selectAll("*").remove(),d3.select("#bar-chart").selectAll("*").remove(),$(".infocus").hide()}